name: Build DARK Recovery

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'Branch of the manifest repository'
        required: true
        default: '12.1'
      DEVICE_NAME:
        description: 'Device name'
        required: true
        default: 'P661N'
      BUILD_TARGET:
        description: 'Build target (e.g. boot, recovery)'
        required: true
        default: 'boot'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Check Out
        uses: actions/checkout@v3
        with:
          repository: KernelBuilding/RecoveryTree-Itel-P55-5G
          ref: TWRP_A13
          
      - name: Cleanup
        uses: rokibhasansagar/slimhub_actions@main

      - name: Prepare the environment
        run: |
          sudo apt update
          sudo apt -y upgrade
          sudo apt -y install gperf gcc-multilib gcc-10-multilib g++-multilib g++-10-multilib libc6-dev lib32ncurses5-dev x11proto-core-dev libx11-dev tree lib32z-dev libgl1-mesa-dev libxml2-utils xsltproc bc ccache lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libwxgtk3.0-gtk3-dev libxml2 lzop pngcrush schedtool squashfs-tools imagemagick libbz2-dev lzma ncftp qemu-user-static libstdc++-10-dev libncurses5 python3
      
      - name: Install repo
        run: |
          mkdir ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          sudo ln -sf ~/bin/repo /usr/bin/repo

      - name: Setup git
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.build"

      - name: Initialize repo
        run: |
          mkdir workspace
          cd workspace
          echo "workspace-folder=$(pwd)" >> $GITHUB_OUTPUT
          repo init --depth=1 -u https://github.com/KernelBuilding/dark_manifest.git -b twrp-${{ github.event.inputs.MANIFEST_BRANCH }}
        id: pwd
          
      - name: Repo Sync
        run: |
          repo sync -j$(nproc --all) --force-sync
        working-directory: workspace

      - name: Copy Device Tree
        run: |
          echo $(ls *)
          mkdir -p ${GITHUB_WORKSPACE}/workspace/device/itel/${{ github.event.inputs.DEVICE_NAME }} # Pastikan folder tujuan ada
          cp Android.mk ${GITHUB_WORKSPACE}/workspace/device/itel/${{ github.event.inputs.DEVICE_NAME }}
          cp AndroidProducts.mk ${GITHUB_WORKSPACE}/workspace/device/itel/${{ github.event.inputs.DEVICE_NAME }} 
          cp BoardConfig.mk ${GITHUB_WORKSPACE}/workspace/device/itel/${{ github.event.inputs.DEVICE_NAME }} 
          cp device.mk ${GITHUB_WORKSPACE}/workspace/device/itel/${{ github.event.inputs.DEVICE_NAME }} 
          cp README.md ${GITHUB_WORKSPACE}/workspace/device/itel/${{ github.event.inputs.DEVICE_NAME }} 
          cp -r mtk_plpath_utils ${GITHUB_WORKSPACE}/workspace/device/itel/${{ github.event.inputs.DEVICE_NAME }} 
          cp -r bootctrl ${GITHUB_WORKSPACE}/workspace/device/itel/${{ github.event.inputs.DEVICE_NAME }} 
          cp -r prebuilt ${GITHUB_WORKSPACE}/workspace/device/itel/${{ github.event.inputs.DEVICE_NAME }} 
          cp system.prop ${GITHUB_WORKSPACE}/workspace/device/itel/${{ github.event.inputs.DEVICE_NAME }} 
          cp twrp_P661N.mk ${GITHUB_WORKSPACE}/workspace/device/itel/${{ github.event.inputs.DEVICE_NAME }} 
          cp -r recovery ${GITHUB_WORKSPACE}/workspace/device/itel/${{ github.event.inputs.DEVICE_NAME }} 
    
      - name: Set Swap Space
        uses: pierotofy/set-swap-space@master
        with:
          swap-size-gb: 15
        
      - name: Building recovery
        run: |
          source build/envsetup.sh
          export ALLOW_MISSING_DEPENDENCIES=true
          export BUILD_USERNAME="ProjectKernel2"
          export BUILD_HOSTNAME="Ubuntu"
          lunch twrp_${{ github.event.inputs.DEVICE_NAME }}-eng && make clean && make ${{ github.event.inputs.BUILD_TARGET }}image -j$(nproc --all)
        working-directory: ${{ steps.pwd.outputs.workspace-folder }}

      - name: Set Release Properties
        run: |
          echo "BUILD_DATE=$(TZ=Asia/Jakarta date +%Y%m%d)" >> $GITHUB_ENV
          echo "MD5_IMG=$(md5sum workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/${{ github.event.inputs.BUILD_TARGET }}.img | cut -d ' ' -f 1)" >> $GITHUB_ENV
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: | 
            workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/${{ github.event.inputs.BUILD_TARGET }}.img
            workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.zip
            workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*vendor*.img
          name: ${{ github.event.inputs.DEVICE_NAME }}-${{ github.run_id }}
          tag_name: ${{ github.run_id }}
          body: |
            ## TWRP Recovery - Unofficial
            Devices : ${{ github.event.inputs.DEVICE_NAME }}
            Build Date : ${{ env.BUILD_DATE }}
            ## MD5 Files
            MD5 IMG    : ${{ env.MD5_IMG }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
